name: Backend CI

# Run tests before merging to main
on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Poetry
      run: |
        curl -sSL https://install.python-poetry.org | python3 -
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    
    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
    
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: backend/.venv
        key: venv-${{ runner.os }}-${{ hashFiles('backend/poetry.lock') }}
        restore-keys: |
          venv-${{ runner.os }}-
    
    - name: Install dependencies
      working-directory: ./backend
      run: poetry install --with dev
    
    - name: Run pytest
      working-directory: ./backend
      run: |
        poetry run pytest \
          --cov=app \
          --cov-report=term-missing \
          --cov-report=xml \
          --cov-report=html \
          -v
    
    - name: Verify coverage threshold
      working-directory: ./backend
      run: |
        poetry run coverage report --fail-under=85
    
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          backend/coverage.xml
          backend/htmlcov/
        retention-days: 30
    
    - name: Test summary
      if: always()
      working-directory: ./backend
      run: |
        echo "## Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        poetry run coverage report --format=markdown >> $GITHUB_STEP_SUMMARY

